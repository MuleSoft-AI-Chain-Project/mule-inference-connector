<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	  xmlns:mac-inference="http://www.mulesoft.org/schema/mule/mac-inference" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	  xmlns:munit="http://www.mulesoft.org/schema/mule/munit" xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	  xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
http://www.mulesoft.org/schema/mule/mac-inference http://www.mulesoft.org/schema/mule/mac-inference/current/mule-mac-inference.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<munit:config name="generate-image.xml" >
		<munit:parameterizations >
			<munit:parameterization name="openai-config" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="OpenAIImageGen" />
					<munit:parameter propertyName="imageGenModel" value="${openai.imageGenModel}" />
				</munit:parameters>
			</munit:parameterization>
			<munit:parameterization name="xai-config" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="XAIImageGenConfig" />
					<munit:parameter propertyName="imageGenModel" value="${xai.imageGenModel}" />
				</munit:parameters>
			</munit:parameterization>
			<munit:parameterization name="stability-config" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="StabilityImageGenConfig" />
					<munit:parameter propertyName="imageGenModel" value="${stability.imageGenModel}" />
				</munit:parameters>
			</munit:parameterization>
			<munit:parameterization name="huggingface-config" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="HuggingFaceImageGenConfig" />
					<munit:parameter propertyName="imageGenModel" value="${huggingface.imageGenModel}" />
				</munit:parameters>
			</munit:parameterization>
		</munit:parameterizations>
	</munit:config>
	<munit:test name="generate-image-operations-Test" doc:id="760d7463-26ea-4153-907c-8aba1322df2d" >
		<munit:execution >
			<flow-ref doc:name="Flow-ref to image-gen" doc:id="8d683a76-2c57-4140-bd1f-1b2abb132f7d" name="generate-image-operation"/>
			<logger level="INFO" doc:name="Logger" doc:id="ab7328c0-166d-4e28-92df-bdc09d9e266b" message="#[payload]"/>
		</munit:execution>
		<munit:validation >
			<munit-tools:assert-that doc:name="payload.response" doc:id="fae1084b-46e2-4292-8de9-d52db5479b1a" message="Payload response is wrong answer" expression="#[payload.payload.response]" is="#[MunitTools::notNullValue()]" />
			<munit-tools:assert-equals doc:name="model Info" doc:id="0d983fa9-11ae-49b2-8218-fd1e9a29d294" actual="#[attributes.additionalAttributes.model]" expected="${imageGenModel}" message="Incorrect Model Info" />
		</munit:validation>
	</munit:test>
	<sub-flow name="generate-image-operation" doc:id="d9e66d71-b2ee-42d9-b17c-40b759bb13d1" >
		<set-variable value='#[%dw 2.0&#10;			output application/json&#10;			---&#10;{&#10;    "prompt" : "Generate a picture of a penguin dancing on the beach being happy with an ice cream."&#10;}]' doc:name="testPayload" doc:id="fde09a29-ef05-4e33-a5d1-76981b451f60" variableName="testPayload"/>
		<mac-inference:generate-image doc:name="[Image] Generate (only Base64)" doc:id="5ae95a27-ee79-4f85-b022-dd10ec6c4bbf" config-ref="${config}">
			<mac-inference:prompt ><![CDATA[#[vars.testPayload.prompt]]]></mac-inference:prompt>
		</mac-inference:generate-image>
		<ee:transform doc:name="Transform Message" doc:id="fe77a21c-cf8a-4b6e-ae56-61cdc932ea2b" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	payload: payload,
	attributes: attributes
}]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="payload" ><![CDATA[%dw 2.0
output application/json
---
{
	payload: payload,
	attributes: attributes
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
	</sub-flow>

</mule>
